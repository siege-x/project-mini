---
- name: 04. Deploy Nginx Application on K3s Cluster
  # kubectl 명령을 실행할 권한(kubeconfig)이 있는 server 그룹을 대상으로 합니다.
  hosts: servers
  become: true
  
  # 우리가 만든 nginx-deploy 역할을 호출합니다.
  roles:
    - nginx-deploy

  # (선택 사항) 배포 완료 후 간단한 확인 작업을 추가할 수 있습니다.
  post_tasks:
    - name: Wait for Nginx Pods to be ready
      shell: kubectl wait --for=condition=Ready pod -l app=nginx --timeout=60s
      register: wait_result
      ignore_errors: true

    - name: Final Check - Show Nginx Service URL
      debug:
        msg: "Nginx is available at http://{{ ansible_host }}:30080"
