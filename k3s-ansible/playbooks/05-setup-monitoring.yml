---
- name: Setup Prometheus & Grafana Monitoring
  hosts: servers        # Helm ëª…ë ¹ì€ Master(Server)ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
  become: true          # ê´€ë¦¬ì ê¶Œí•œ(sudo) ì‚¬ìš©
  gather_facts: true    # ì„œë²„ ì •ë³´ ìˆ˜ì§‘
  
  pre_tasks:
    # 1. agents ê·¸ë£¹ì— ìˆëŠ” ì„œë²„ë“¤ì˜ ì •ë³´ë¥¼ ë¯¸ë¦¬ ê°€ì ¸ì˜µë‹ˆë‹¤.
    - name: Get facts from agents for node targeting
      setup:
        delegate_to: "{{ item }}"
        delegate_facts: true
        loop: "{{ groups['agents'] }}"
        ignore_errors: true

    # [ìˆ˜ì •ë¨] ë³€ìˆ˜ë¥¼ ì—¬ê¸°ì„œ ë¯¸ë¦¬ í™•ì • ì§€ì–´ì„œ 'ì „ì—­ ë³€ìˆ˜'ë¡œ ë§Œë“­ë‹ˆë‹¤.
    # ê·¸ë˜ì•¼ ë‚˜ì¤‘ì— post_tasksì—ì„œë„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - name: Set target node name globally
      set_fact:
        target_node_name: "{{ hostvars[groups['agents'][0]]['ansible_hostname'] }}"

  roles:
    - role: monitoring
      vars:
        # ìœ„ì—ì„œ ë§Œë“  ì „ì—­ ë³€ìˆ˜ë¥¼ ì—­í• ì— ë„˜ê²¨ì¤ë‹ˆë‹¤.
        target_node: "{{ target_node_name }}"

  post_tasks:
    # ì„¤ì¹˜ ì™„ë£Œ í›„ ì ‘ì† ì •ë³´ë¥¼ í™”ë©´ì— ì˜ˆì˜ê²Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    - name: Display Grafana Access Info
      debug:
        msg: 
          - "ğŸ‰ Monitoring Stack Deployed on Agent Node: {{ target_node_name }}"
          - "ğŸ”— Access URL: http://{{ ansible_host }}:{{ grafana_node_port }}"
          - "ğŸ”‘ User: admin / Password: {{ grafana_admin_password }}"
