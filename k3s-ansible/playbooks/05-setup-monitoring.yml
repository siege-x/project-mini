---
- name: Setup Prometheus & Grafana Monitoring
  hosts: servers       # Helm ëª…ë ¹ì€ Master(Server)ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
  become: true         # ê´€ë¦¬ì ê¶Œí•œ(sudo) ì‚¬ìš©
  gather_facts: true   # ì„œë²„ ì •ë³´ ìˆ˜ì§‘
  
  pre_tasks:
    # 1. agents ê·¸ë£¹ì— ìˆëŠ” ì„œë²„ë“¤ì˜ ì •ë³´ë¥¼ ë¯¸ë¦¬ ê°€ì ¸ì˜µë‹ˆë‹¤.
    # ê·¸ë˜ì•¼ 'ì²« ë²ˆì§¸ ë†ˆ ì´ë¦„ì´ ë­ì•¼?'ë¼ê³  ë¬¼ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - name: Get facts from agents for node targeting
      setup:
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['agents'] }}"
      ignore_errors: true

  roles:
    - role: monitoring
      vars:
        # [í•µì‹¬ ë¡œì§]
        # Terraformì´ Fixed IP í•˜ë‚˜ë§Œ ì¤¬ìœ¼ë¯€ë¡œ, agents[0]ì€ ë¬´ì¡°ê±´ Fixed Agentì…ë‹ˆë‹¤.
        # ê·¸ ë…€ì„ì˜ ì‹¤ì œ ì»´í“¨í„° ì´ë¦„(hostname)ì„ ì•Œì•„ë‚´ì„œ ë³€ìˆ˜ë¡œ ë„˜ê¹ë‹ˆë‹¤.
        target_node_name: "{{ hostvars[groups['agents'][0]]['ansible_hostname'] }}"

  post_tasks:
    # ì„¤ì¹˜ ì™„ë£Œ í›„ ì ‘ì† ì •ë³´ë¥¼ í™”ë©´ì— ì˜ˆì˜ê²Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    - name: Display Grafana Access Info
      debug:
        msg: 
          - "ğŸ‰ Monitoring Stack Deployed on Agent Node: {{ target_node_name }}"
          - "ğŸ”— Access URL: http://{{ ansible_host }}:{{ grafana_node_port }}"
          - "ğŸ”‘ User: admin / Password: {{ grafana_admin_password }}"
