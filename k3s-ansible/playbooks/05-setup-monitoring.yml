---
- name: Setup Prometheus & Grafana Monitoring
  hosts: servers
  become: true
  gather_facts: true  # ë§ˆìŠ¤í„° ë…¸ë“œ ì •ë³´ ìˆ˜ì§‘
  
  pre_tasks:
    # [ìˆ˜ì • 1] setup ëª¨ë“ˆ ì—ëŸ¬ í•´ê²°
    # delegate_toì™€ delegate_factsë¥¼ setup: ë°‘ì´ ì•„ë‹ˆë¼, ë°–ìœ¼ë¡œ ëºìŠµë‹ˆë‹¤. (ë“¤ì—¬ì“°ê¸° ìˆ˜ì •)
    - name: Get facts from agents for node targeting
      setup:
        gather_subset: all
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['agents'] }}"
      ignore_errors: true

    # [ìˆ˜ì • 2] Deprecation Warning ì›ì²œ ì œê±°
    # ansible_hostname -> ansible_facts['hostname'] ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ê²½ê³  ì‚­ì œ
    - name: Set target node name globally
      set_fact:
        target_node_name: "{{ hostvars[groups['agents'][0]]['ansible_facts']['hostname'] }}"

  roles:
    - role: monitoring
      vars:
        target_node: "{{ target_node_name }}"

  post_tasks:
    # [ìˆ˜ì • 3] ë§ˆì§€ë§‰ ì¶œë ¥ ë©”ì‹œì§€ì—ì„œë„ ê²½ê³ ê°€ ì•ˆ ëœ¨ë„ë¡ ë¬¸ë²• ìˆ˜ì •
    - name: Display Grafana Access Info
      debug:
        msg: 
          - "ğŸ‰ Monitoring Stack Deployed on Agent Node: {{ target_node_name }}"
          - "ğŸ”— Access URL: http://{{ ansible_host }}:{{ grafana_node_port }}"
          - "ğŸ”‘ User: admin / Password: {{ grafana_admin_password }}"
