---
- name: Setup Prometheus & Grafana Monitoring
  hosts: servers
  become: true
  gather_facts: true
  
  pre_tasks:
    # 1. agents ê·¸ë£¹ ì •ë³´ ìˆ˜ì§‘
    - name: Get facts from agents for node targeting
      setup:
        delegate_to: "{{ item }}"
        delegate_facts: true
      # [ìˆ˜ì •ë¨] loopëŠ” setup ëª¨ë“ˆì˜ ìì‹ì´ ì•„ë‹ˆë¼, í˜•ì œ ë ˆë²¨ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (ë“¤ì—¬ì“°ê¸° ì•ìœ¼ë¡œ ë‹¹ê¹€)
      loop: "{{ groups['agents'] }}"
      ignore_errors: true

    # 2. íƒ€ê²Ÿ ë…¸ë“œ ë³€ìˆ˜ ì „ì—­ ì„¤ì •
    - name: Set target node name globally
      set_fact:
        target_node_name: "{{ hostvars[groups['agents'][0]]['ansible_hostname'] }}"

  roles:
    - role: monitoring
      vars:
        target_node: "{{ target_node_name }}"

  post_tasks:
    - name: Display Grafana Access Info
      debug:
        msg: 
          - "ğŸ‰ Monitoring Stack Deployed on Agent Node: {{ target_node_name }}"
          - "ğŸ”— Access URL: http://{{ ansible_host }}:{{ grafana_node_port }}"
          - "ğŸ”‘ User: admin / Password: {{ grafana_admin_password }}"
