---
# 1. 필수 도구 및 라이브러리 설치
- name: Install python3-pip
  apt:
    name: python3-pip
    state: present
    update_cache: yes
  become: yes

- name: Install kubernetes python library and PyYAML
  pip:
    name:
      - kubernetes
      - PyYAML
    state: latest
  become: yes

# 2. 표준 설정 폴더 및 파일 구성 (이게 핵심!)
- name: Create .kube directory
  file:
    path: /root/.kube
    state: directory
    mode: '0755'
  become: yes

- name: Copy k3s config to default kubeconfig location
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /root/.kube/config
    remote_src: yes
    mode: '0600'
  become: yes

# 3. K3s API 대기
- name: Wait for K3s API server to be ready
  wait_for:
    host: localhost
    port: 6443
    delay: 5
    timeout: 60

# 4. Nginx 배포 (kubeconfig 설정을 아예 삭제했습니다. 자동 인식됨)
- name: Deploy Nginx Deployment
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'deployment.yml.j2') }}"
  become: yes

# 5. Service 배포
- name: Deploy Nginx Service
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'service.yml.j2') }}"
  become: yes

# 6. HPA 배포
- name: Deploy HPA
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'hpa.yml.j2') }}"
  become: yes
