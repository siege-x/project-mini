---
# [1] ê¸°ì¡´ ì°Œêº¼ê¸° ì²­ì†Œ
- name: Clean up temporary files
  shell: rm -rf /tmp/all-crds.yaml /tmp/crd-split
  become: yes
  ignore_errors: yes

# [2] ê¸°ì´ˆ ê³µì‚¬ (Helm Repo ì¶”ê°€)
- name: Add Prometheus Community Helm Repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: yes

# ======================================================================
# ğŸš€ [í•µì‹¬] í´ë” ë’¤ì ê±°ë¦¬ì§€ ì•Šê³  ì„¤ê³„ë„ ì§ì ‘ ìƒì„± (189ë²ˆ ì—ëŸ¬ ì›ì²œ ì°¨ë‹¨)
# ======================================================================
- name: Generate and Split CRDs directly
  shell: |
    set -e
    # í´ë”ë¥¼ ë’¤ì§€ëŠ” ëŒ€ì‹  í—¬ë¦„ í…œí”Œë¦¿ ì—”ì§„ìœ¼ë¡œ ì„¤ê³„ë„ ë‚´ìš©ë§Œ í…ìŠ¤íŠ¸ë¡œ ë°”ë¡œ ë½‘ì•„ëƒ…ë‹ˆë‹¤.
    /usr/local/bin/helm template prom-crds prometheus-community/prometheus-operator-crds > /tmp/all-crds.yaml

    # ìª¼ê°œì§„ íŒŒì¼ì„ ë‹´ì„ í´ë” ìƒì„±
    mkdir -p /tmp/crd-split
    cd /tmp/crd-split

    # íŒŒì´ì¬ìœ¼ë¡œ ì§„ì§œ ì•Œë§¹ì´(kind:)ê°€ ìˆëŠ” ê²ƒë§Œ ê³¨ë¼ ë‚±ê°œ íŒŒì¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
    python3 -c '
    import sys
    with open("/tmp/all-crds.yaml", "r") as f:
        for i, doc in enumerate(f.read().split("---")):
            if "kind:" in doc.strip():
                with open(f"crd-{i}.yaml", "w") as o: o.write(doc.strip())
    '

    # ìƒì„±ëœ ë‚±ê°œ íŒŒì¼ë“¤ì„ í•˜ë‚˜ì”© ì ìš©í•©ë‹ˆë‹¤. (ê²½ë¡œ ì¶”ì  ì•ˆ í•¨)
    for f in crd-*.yaml; do
      echo "Applying $f ..."
      kubectl apply --server-side --force-conflicts -f "$f"
      sleep 2
    done
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes

# [3] ë©”ì¸ ì•± ì„¤ì¹˜ (ì´ë¯¸ CRDëŠ” ë„£ì—ˆìœ¼ë‹ˆ ë¬´ì‹œí•˜ê³  ì§„í–‰)
- name: Deploy kube-prometheus-stack
  shell: |
    /usr/local/bin/helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
      --namespace {{ monitoring_namespace }} \
      --values /tmp/monitor-values.yml \
      --set prometheusOperator.admissionWebhooks.enabled=false \
      --skip-crds \
      --wait=false
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes
