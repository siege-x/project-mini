---
# 1. Helm ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
- name: Install Helm setup script
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  become: yes

# 2. í•„ìˆ˜ Python íŒ¨í‚¤ì§€ (k8s ëª¨ë“ˆìš©)
- name: Install Python dependencies
  apt:
    name: python3-kubernetes
    state: present
  become: yes

# 3. Helm Repo ì¶”ê°€
- name: Add Prometheus Community Helm Repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: yes

# 4. ëª¨ë‹ˆí„°ë§ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
  become: yes

# 5. ì„¤ì • íŒŒì¼ ìƒì„± (Jinja2 í…œí”Œë¦¿)
- name: Render Prometheus Stack values file
  template:
    src: monitor-values.yml.j2
    dest: /tmp/monitor-values.yml
  vars:
    target_node: "{{ target_node_name | default('') }}"
    cluster_ip: "{{ ansible_host }}"
  become: yes

# ======================================================================
# [1ë‹¨ê³„] CRD(ì„¤ê³„ë„) ì„¤ì¹˜ - "ì„±ê³µí•  ë•Œê¹Œì§€ ì¬ì‹œë„!"
# ======================================================================

# ğŸ›‘ [ì¶”ê°€ëœ ë¶€ë¶„] ë ˆí¬ì§€í† ë¦¬ ì •ë³´ ê°±ì‹  (í™•ì‹¤í•˜ê²Œ í•˜ê¸° ìœ„í•´)
# ì¸í„°ë„·ì´ ì ê¹ ëŠê²¨ë„ ê¸°ì¡´ ì •ë³´ë¡œë¼ë„ ì§„í–‰í•˜ë„ë¡ ì—ëŸ¬ ë¬´ì‹œ ì„¤ì • ì¶”ê°€
- name: Update Helm Repo Forcefully
  shell: /usr/local/bin/helm repo update
  become: yes
  ignore_errors: yes

- name: Install Prometheus CRDs (Retry Loop)
  shell: |
    /usr/local/bin/helm upgrade --install prometheus-crds prometheus-community/prometheus-operator-crds \
      --namespace {{ monitoring_namespace }} \
      --create-namespace \
      --wait=false \
      --timeout 10m \
      --disable-openapi-validation
  become: yes
  register: crd_install_result
  # ğŸ›‘ í•µì‹¬: ì„±ê³µ(rc=0)í•  ë•Œê¹Œì§€ ìµœëŒ€ 5ë²ˆ, 1ë¶„ ê°„ê²©ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.
  # íƒ€ì„ì•„ì›ƒ ë‚˜ì„œ ì¼ë¶€ë§Œ ê¹”ë ¤ë„, ë‹¤ì‹œ ì‹¤í–‰í•˜ë©´ ë‚˜ë¨¸ì§€ ì„¤ì¹˜í•©ë‹ˆë‹¤.
  until: crd_install_result.rc == 0
  retries: 5
  delay: 60

# ======================================================================
# [íœ´ì‹] ì¬ì‹œë„í•˜ëŠë¼ ê³ ìƒí–ˆì„ í…Œë‹ˆ 2ë¶„ ì‰½ë‹ˆë‹¤.
# ======================================================================
- name: Pause for CRD registration
  pause:
    minutes: 2

# ======================================================================
# [ê²€ì¦] "í”„ë¡œë©”í…Œìš°ìŠ¤" ì„¤ê³„ë„ê°€ ì§„ì§œ ìˆëŠ”ì§€ í™•ì¸ (íƒ€ê²Ÿ ë³€ê²½!)
# ì•„ê¹ŒëŠ” ServiceMonitorë§Œ í™•ì¸í•´ì„œ í†µê³¼ëœ ê²ë‹ˆë‹¤. ì´ë²ˆì—” Prometheusë¥¼ ë´…ë‹ˆë‹¤.
# ======================================================================
- name: Verify 'Prometheus' CRD is ready
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: prometheuses.monitoring.coreos.com
  register: crd_check
  until: crd_check.resources | length > 0
  retries: 20
  delay: 10
  become: yes

# ======================================================================
# [2ë‹¨ê³„] ë©”ì¸ ì•± ì„¤ì¹˜ (ê²€ì‚¬ ìƒëµ)
# ======================================================================
- name: Deploy kube-prometheus-stack (Via Raw Shell)
  shell: |
    /usr/local/bin/helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
      --namespace {{ monitoring_namespace }} \
      --values /tmp/monitor-values.yml \
      --set prometheusOperator.admissionWebhooks.enabled=false \
      --set prometheusOperator.admissionWebhooks.patch.enabled=false \
      --set prometheusOperator.tls.enabled=false \
      --set alertmanager.enabled=false \
      --skip-crds \
      --wait=false \
      --timeout 20m \
      --disable-openapi-validation
  become: yes

# ======================================================================
# [3ë‹¨ê³„] ìµœì¢… ê²€ì¦
# ======================================================================
- name: Wait for Prometheus Pod
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=prometheus
  register: pod_list
  until: pod_list.resources | length > 0 and (pod_list.resources[0].status.phase == 'Running')
  retries: 40
  delay: 30
  become: yes

- name: Wait for Grafana Pod
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=grafana
  register: grafana_pod
  until: grafana_pod.resources | length > 0 and (grafana_pod.resources[0].status.phase == 'Running')
  retries: 40
  delay: 30
  become: yes
