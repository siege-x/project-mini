---
# ======================================================================
# [0단계] 사전 청소 (좀비 프로세스 정리)
# 아까 강제 종료 때문에 남아있을지 모르는 헬름 프로세스를 확실히 죽입니다.
# 그래야 "Lock file" 에러나 "무한 대기"가 안 생깁니다.
# ======================================================================
- name: Kill stuck helm processes
  shell: pkill -9 helm
  become: yes
  ignore_errors: yes # 실행 중인 게 없으면 에러 나니까 무시

# 1. Helm 설치 스크립트
- name: Install Helm setup script
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  become: yes

# 2. 필수 패키지
- name: Install Python dependencies
  apt:
    name: python3-kubernetes
    state: present
  become: yes

# 3. 레포지토리 추가
- name: Add Prometheus Community Helm Repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: yes

# 4. 네임스페이스 생성
- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
  become: yes

# 5. 설정 파일 생성
- name: Render Prometheus Stack values file
  template:
    src: monitor-values.yml.j2
    dest: /tmp/monitor-values.yml
  vars:
    target_node: "{{ target_node_name | default('') }}"
    cluster_ip: "{{ ansible_host }}"
  become: yes

# ======================================================================
# [1단계] CRD 설치 (전략: 치고 빠지기)
# 10분 기다리지 않습니다. 3분 안에 반응 없으면 죽이고 다시 합니다.
# ======================================================================
- name: Update Helm Repo
  shell: /usr/local/bin/helm repo update
  become: yes
  ignore_errors: yes

- name: Install Prometheus CRDs (Fail Fast & Retry)
  shell: |
    /usr/local/bin/helm upgrade --install prometheus-crds prometheus-community/prometheus-operator-crds \
      --namespace {{ monitoring_namespace }} \
      --create-namespace \
      --wait=false \
      --timeout 3m \
      --disable-openapi-validation
  become: yes
  register: crd_install_result
  # 성공할 때까지 최대 5번, 1분 간격으로 재시도
  # "안 되면 빨리 끊고 다시 하는 게" 성공 확률이 훨씬 높습니다.
  until: crd_install_result.rc == 0
  retries: 5
  delay: 60

# ======================================================================
# [휴식] 열 받은 t3.micro 식히기 (필수)
# ======================================================================
- name: Pause for CRD registration
  pause:
    minutes: 2

# ======================================================================
# [중간 점검] 프로메테우스 설계도 확인
# 이게 없으면 뒤에 가서 또 에러 나니까, 확인될 때까지 못 넘어갑니다.
# ======================================================================
- name: Verify 'Prometheus' CRD is ready
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: prometheuses.monitoring.coreos.com
  register: crd_check
  until: crd_check.resources | length > 0
  retries: 30
  delay: 10
  become: yes

# ======================================================================
# [2단계] 메인 앱 설치 (전략: 이어달리기)
# 이미지 다운로드가 오래 걸려서 타임아웃 나면?
# 재시도(Retry)가 돌면서 "다운받다 만 곳"부터 다시 시작해서 결국 성공시킵니다.
# ======================================================================
- name: Deploy kube-prometheus-stack (Retry Strategy)
  shell: |
    /usr/local/bin/helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
      --namespace {{ monitoring_namespace }} \
      --values /tmp/monitor-values.yml \
      --set prometheusOperator.admissionWebhooks.enabled=false \
      --set prometheusOperator.admissionWebhooks.patch.enabled=false \
      --set prometheusOperator.tls.enabled=false \
      --set alertmanager.enabled=false \
      --skip-crds \
      --wait=false \
      --timeout 5m \
      --disable-openapi-validation
  become: yes
  register: main_install_result
  # 메인 설치도 한 번에 안 될 수 있습니다(이미지 다운로드 때문).
  # 그래서 여기도 재시도 로직을 넣었습니다. 이게 "방안"입니다.
  until: main_install_result.rc == 0
  retries: 3
  delay: 60

# ======================================================================
# [3단계] 최종 검증 (초록불 확인)
# ======================================================================
- name: Wait for Prometheus Pod
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=prometheus
  register: pod_list
  until: pod_list.resources | length > 0 and (pod_list.resources[0].status.phase == 'Running')
  retries: 60 # 최대 30분 대기 (이미지 다운로드 시간 고려)
  delay: 30
  become: yes

- name: Wait for Grafana Pod
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=grafana
  register: grafana_pod
  until: grafana_pod.resources | length > 0 and (grafana_pod.resources[0].status.phase == 'Running')
  retries: 60
  delay: 30
  become: yes
