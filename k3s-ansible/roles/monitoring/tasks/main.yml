---
# [ì‚¬ì „ ì²­ì†Œ] í—¬ë¦„ í”„ë¡œì„¸ìŠ¤ ì°Œêº¼ê¸° ì œê±°
- name: Kill stuck helm processes
  shell: pkill -9 helm
  become: yes
  ignore_errors: yes

# ======================================================================
# ğŸ—ï¸ 1. ì¸í”„ë¼ ê¸°ì´ˆ ê³µì‚¬ (ê¸°ì¡´ ìœ ì§€ - ì™„ë²½í•¨)
# ======================================================================
- name: Install Helm setup script
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  become: yes

- name: Install python3-pip
  apt:
    name: python3-pip
    state: present
  become: yes

- name: Install kubernetes python library
  pip:
    name: kubernetes
  become: yes

- name: Add Prometheus Community Helm Repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: yes

- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  become: yes

- name: Render Prometheus Stack values file
  template:
    src: monitor-values.yml.j2
    dest: /tmp/monitor-values.yml
  vars:
    target_node: "{{ target_node_name | default('') }}"
    cluster_ip: "{{ ansible_host }}"
  become: yes

# ======================================================================
# ğŸš€ 2. [ì•„í‚¤í…ì²˜ ì™„ê²°] t3.micro í•œê³„ ëŒíŒŒ: CRD ë¶„í•  ë Œë”ë§ ë° ì ì§„ íˆ¬ì—¬
# ======================================================================
- name: Update Helm Repo
  shell: /usr/local/bin/helm repo update
  become: yes

# ğŸ›‘ [í•µì‹¬ 1] 1ê°œì˜ ê±°ëŒ€í•œ YAMLë¡œ ë½‘ì§€ ì•Šê³ , --output-dir ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì‹­ ê°œì˜ ì‘ì€ íŒŒì¼ë¡œ ìë™ ë¶„í•  ì €ì¥í•©ë‹ˆë‹¤.
- name: Render CRDs into small individual files
  shell: |
    rm -rf /tmp/prom-crds-split
    /usr/local/bin/helm template prom-crds prometheus-community/prometheus-operator-crds --output-dir /tmp/prom-crds-split
  become: yes

# ğŸ›‘ [í•µì‹¬ 2] ìª¼ê°œì§„ ê¼¬ë§ˆ íŒŒì¼ë“¤ì„ í•˜ë‚˜ì”© ì°¾ì•„ì„œ 2ì´ˆ ê°„ê²©ìœ¼ë¡œ API ì„œë²„ì— ë˜ì§‘ë‹ˆë‹¤. (OOM ë©”ëª¨ë¦¬ í­ì£¼ ì›ì²œ ì°¨ë‹¨)
- name: Install CRDs piece by piece safely
  shell: |
    find /tmp/prom-crds-split -name "*.yaml" | while read yaml_file; do
      kubectl apply --server-side --force-conflicts -f "$yaml_file"
      sleep 2
    done
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes

- name: Short pause for API server to digest CRDs
  pause:
    seconds: 15

# ======================================================================
# ğŸš€ 3. [ë©”ì¸ ì•± ì„¤ì¹˜] SSH ëŠê¹€ ë°©ì§€(async) ë„ì…
# ======================================================================
# ğŸ›‘ [í•µì‹¬ 3] ì‘ì—…ì´ ì˜¤ë˜ ê±¸ë¦´ ë•Œ ë°œìƒí•˜ëŠ” UNREACHABLE í†µì‹  ì—ëŸ¬ë¥¼ ë§‰ê¸° ìœ„í•´
# Ansibleì˜ async(ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)ì™€ poll(ì£¼ê¸°ì  í™•ì¸)ì„ ë„ì…í•©ë‹ˆë‹¤.
- name: Deploy kube-prometheus-stack (Main App)
  shell: |
    /usr/local/bin/helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
      --namespace {{ monitoring_namespace }} \
      --values /tmp/monitor-values.yml \
      --set prometheusOperator.admissionWebhooks.enabled=false \
      --set prometheusOperator.admissionWebhooks.patch.enabled=false \
      --set prometheusOperator.tls.enabled=false \
      --set alertmanager.enabled=false \
      --skip-crds \
      --wait=false \
      --timeout 10m \
      --disable-openapi-validation
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes
  async: 900    # ìµœëŒ€ 15ë¶„(900ì´ˆ)ê¹Œì§€ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ì„ í—ˆìš©í•©ë‹ˆë‹¤.
  poll: 15      # 15ì´ˆë§ˆë‹¤ í•œ ë²ˆì”© ì™„ë£Œë˜ì—ˆëŠ”ì§€ ì¡°ìš©íˆ ì²´í¬ë§Œ í•©ë‹ˆë‹¤.

# ======================================================================
# ğŸ 4. íŒŒë“œ ê¸°ë™ í™•ì¸
# ======================================================================
- name: Wait for Prometheus Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=prometheus
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: pod_list
  until: pod_list.resources | length > 0 and (pod_list.resources[0].status.phase == 'Running')
  retries: 40
  delay: 15
  become: yes

- name: Wait for Grafana Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=grafana
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: grafana_pod
  until: grafana_pod.resources | length > 0 and (grafana_pod.resources[0].status.phase == 'Running')
  retries: 40
  delay: 15
  become: yes
