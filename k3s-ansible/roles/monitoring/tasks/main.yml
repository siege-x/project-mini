---
# [ì‚¬ì „ ì²­ì†Œ] 
- name: Kill stuck helm processes
  shell: pkill -9 helm
  become: yes
  ignore_errors: yes

# 1. Helm & Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
- name: Install Helm setup script
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  become: yes

- name: Install Python dependencies
  apt:
    name: python3-kubernetes
    state: present
  become: yes

# 2. Repo ì¶”ê°€ ë° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
- name: Add Prometheus Community Helm Repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: yes

- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
  become: yes

- name: Render Prometheus Stack values file
  template:
    src: monitor-values.yml.j2
    dest: /tmp/monitor-values.yml
  vars:
    target_node: "{{ target_node_name | default('') }}"
    cluster_ip: "{{ ansible_host }}"
  become: yes

# ======================================================================
# ğŸš€ [ë°œí‘œìš© í•µì‹¬ ìµœì í™”] CRD ë¶„ë¦¬ ë° ì´ˆê³ ì† ì§ì ‘ ì„¤ì¹˜
# í—¬ë¦„ì˜ ë¬´ê±°ìš´ ë¡œì§ì„ í”¼í•´, ì°¨íŠ¸ ì••ì¶•ì„ í’€ê³  kubectlë¡œ 10ì´ˆ ë§Œì— ë°€ì–´ë„£ìŠµë‹ˆë‹¤.
# ======================================================================
- name: Update Helm Repo
  shell: /usr/local/bin/helm repo update
  become: yes

- name: Download and Untar kube-prometheus-stack (Fast Download)
  shell: /usr/local/bin/helm pull prometheus-community/kube-prometheus-stack --untar --dest /tmp
  become: yes

- name: Install CRDs via Kubectl directly (Ultra Fast Bypass)
  shell: kubectl apply --server-side -f /tmp/kube-prometheus-stack/crds/
  become: yes
  # ğŸ‘† ì´ ëª…ë ¹ì–´ê°€ Helm ëŒ€ì‹  CRDë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤. ë©”ëª¨ë¦¬ ë‚­ë¹„ê°€ ì—†ì–´ ë©ˆì¶”ì§€ ì•ŠìŠµë‹ˆë‹¤.

# ======================================================================
# ğŸš€ [ë©”ì¸ ì•± ì„¤ì¹˜] ë¶ˆí•„ìš”í•œ ëŒ€ê¸° ì—†ì´ ë‹¤ì´ë ‰íŠ¸ ëŸ°
# ======================================================================
- name: Deploy kube-prometheus-stack (Main App)
  shell: |
    /usr/local/bin/helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
      --namespace {{ monitoring_namespace }} \
      --values /tmp/monitor-values.yml \
      --set prometheusOperator.admissionWebhooks.enabled=false \
      --set prometheusOperator.admissionWebhooks.patch.enabled=false \
      --set prometheusOperator.tls.enabled=false \
      --set alertmanager.enabled=false \
      --skip-crds \
      --wait=false \
      --timeout 5m
  become: yes

# ======================================================================
# ğŸ íŒŒë“œ ê¸°ë™ í™•ì¸ (ì˜ìƒ ë§ˆë¬´ë¦¬ë¥¼ ìœ„í•œ ê¹”ë”í•œ ëŒ€ê¸°)
# ======================================================================
- name: Wait for Prometheus Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=prometheus
  register: pod_list
  until: pod_list.resources | length > 0 and (pod_list.resources[0].status.phase == 'Running')
  retries: 20
  delay: 30
  become: yes

- name: Wait for Grafana Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=grafana
  register: grafana_pod
  until: grafana_pod.resources | length > 0 and (grafana_pod.resources[0].status.phase == 'Running')
  retries: 20
  delay: 30
  become: yes
