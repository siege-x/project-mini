---
# 1. Helm ì„¤ì¹˜
- name: Install Helm setup script
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  become: yes

# 2. í•„ìˆ˜ íŒ¨í‚¤ì§€
- name: Install Python dependencies
  apt:
    name: python3-kubernetes
    state: present
  become: yes

# 3. ì €ì¥ì†Œ ì¶”ê°€
- name: Add Prometheus Community Helm Repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: yes

# 4. ë„¤ì„ìŠ¤í˜ì´ìŠ¤
- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
  become: yes

# 5. ì„¤ì • íŒŒì¼
- name: Render Prometheus Stack values file
  template:
    src: monitor-values.yml.j2
    dest: /tmp/monitor-values.yml
  vars:
    target_node: "{{ target_node_name | default('') }}"
    cluster_ip: "{{ ansible_host }}"
  become: yes

# ======================================================================
# 1ë‹¨ê³„: CRD(ì„¤ê³„ë„) ì„¤ì¹˜ - "ì¼ë‹¨ ë˜ì ¸(wait: no)"
# ======================================================================
- name: Install Prometheus CRDs (Async)
  kubernetes.core.helm:
    name: prometheus-crds
    chart_ref: prometheus-community/prometheus-operator-crds
    release_namespace: "{{ monitoring_namespace }}"
    update_repo_cache: yes
    wait: no
    timeout: 10m
  become: yes

# ======================================================================
# ğŸ›‘ [ìµœì í™”] 2ë¶„ íœ´ì‹ (ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¼ 2ë¶„ì´ë©´ ì¶©ë¶„!)
# ======================================================================
- name: Give t3.micro a short break (2 mins)
  pause:
    minutes: 2

# ======================================================================
# ğŸ›‘ [ì•ˆì „ì¥ì¹˜] CRD ë“±ë¡ í™•ì¸
# 2ë¶„ì„ ì‰¬ì—ˆëŠ”ë° í˜¹ì‹œë¼ë„ ë””ìŠ¤í¬ê°€ ëŠë ¤ì„œ ë“±ë¡ ì•ˆ ëì„ê¹Œ ë´ í™•ì¸ë§Œ í•©ë‹ˆë‹¤.
# ======================================================================
- name: Verify CRD is actually ready
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: servicemonitors.monitoring.coreos.com
  register: crd_check
  until: crd_check.resources | length > 0
  retries: 20  # 10ì´ˆ * 20ë²ˆ = ìµœëŒ€ 3ë¶„ ë” ê¸°ë‹¤ë ¤ì¤Œ (ì•ˆì „ë¹µ)
  delay: 10
  become: yes

# ======================================================================
# 2ë‹¨ê³„: ë©”ì¸ ì•± ì„¤ì¹˜
# ======================================================================
- name: Deploy kube-prometheus-stack (Async)
  kubernetes.core.helm:
    name: monitoring
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: "{{ monitoring_namespace }}"
    values_files:
      - /tmp/monitor-values.yml
    values:
      prometheusOperator:
        admissionWebhooks:
          enabled: false
          patch:
            enabled: false
        tls:
          enabled: false
      alertmanager:
        enabled: false
    
    skip_crds: yes  # ìœ„ì—ì„œ í™•ì¸ê¹Œì§€ ëëƒˆìœ¼ë‹ˆ ì•ˆì‹¬í•˜ê³  ìŠ¤í‚µ
    wait: no
    timeout: 20m
  become: yes

# ======================================================================
# 3ë‹¨ê³„: ìµœì¢… ê²€ì¦
# ======================================================================
- name: Wait for Prometheus to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=prometheus
  register: pod_list
  until: pod_list.resources | length > 0 and (pod_list.resources[0].status.phase == 'Running')
  retries: 40
  delay: 30
  become: yes

- name: Wait for Grafana to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=grafana
  register: grafana_pod
  until: grafana_pod.resources | length > 0 and (grafana_pod.resources[0].status.phase == 'Running')
  retries: 40
  delay: 30
  become: yes
