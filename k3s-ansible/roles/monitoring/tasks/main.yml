# ======================================================================
# ğŸš€ [ì•„í‚¤í…ì²˜ ë¡¤ë°±] t3.micro ìƒì¡´ì„ ìœ„í•œ CRD ë¶„ë¦¬ ë° ì´ì¤‘ ì••ì¶• í•´ì œ
# ======================================================================
- name: Update Helm Repo
  shell: /usr/local/bin/helm repo update
  become: yes

- name: Download and Extract kube-prometheus-stack and CRDs
  shell: |
    # 1. ì°Œêº¼ê¸° ì´ˆê¸°í™” ë° ë©”ì¸ ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ (ì••ì¶• í•´ì œ í¬í•¨)
    rm -rf /tmp/kube-prometheus-stack* /tmp/prometheus-operator-crds*
    cd /tmp
    /usr/local/bin/helm pull prometheus-community/kube-prometheus-stack --untar
    
    # 2. [í•µì‹¬ ë°©ì–´ ë¡œì§] ìˆ¨ê²¨ì§„ CRD ì„œë¸Œì°¨íŠ¸ ì´ì¤‘ ì••ì¶• í•´ì œ
    # charts í´ë” ì•ˆì— ìˆ¨ê²¨ì§„ prometheus-operator-crds ì••ì¶•ì„ í•œ ë²ˆ ë” í’€ì–´ëƒ…ë‹ˆë‹¤.
    tar -xzf /tmp/kube-prometheus-stack/charts/prometheus-operator-crds-*.tgz -C /tmp
  become: yes

# 3. ì¶”ì¶œëœ ì •í™•í•œ ê²½ë¡œ(/tmp/prometheus-operator-crds/crds/)ì—ì„œ ì„œë²„ì‚¬ì´ë“œ ì–´í”Œë¼ì´ ì‹¤í–‰
- name: Install CRDs via Kubectl directly (Server-Side Apply)
  shell: kubectl apply --server-side -f /tmp/prometheus-operator-crds/crds/
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes

- name: Short pause for API server to digest CRDs
  pause:
    seconds: 15

# ======================================================================
# ğŸš€ [ë©”ì¸ ì•± ì„¤ì¹˜] CRD ìŠ¤í‚µ ë° ê²½ëŸ‰í™” ë°°í¬ (ê³¼ë¶€í•˜ ë°©ì§€)
# ======================================================================
- name: Deploy kube-prometheus-stack (Main App)
  shell: |
    /usr/local/bin/helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
      --namespace {{ monitoring_namespace }} \
      --values /tmp/monitor-values.yml \
      --set prometheusOperator.admissionWebhooks.enabled=false \
      --set prometheusOperator.admissionWebhooks.patch.enabled=false \
      --set prometheusOperator.tls.enabled=false \
      --set alertmanager.enabled=false \
      --skip-crds \
      --wait=false \
      --timeout 10m \
      --disable-openapi-validation
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes

# ======================================================================
# ğŸ íŒŒë“œ ê¸°ë™ í™•ì¸
# ======================================================================
- name: Wait for Prometheus Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=prometheus
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: pod_list
  until: pod_list.resources | length > 0 and (pod_list.resources[0].status.phase == 'Running')
  retries: 40
  delay: 15
  become: yes

- name: Wait for Grafana Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=grafana
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: grafana_pod
  until: grafana_pod.resources | length > 0 and (grafana_pod.resources[0].status.phase == 'Running')
  retries: 40
  delay: 15
  become: yes
