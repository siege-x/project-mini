---
# 1. Helm 설치 스크립트 실행
- name: Install Helm setup script
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  become: yes

# 2. [정석 구현] 플러그인 목록을 먼저 '조회'합니다. (에러 발생 없음, 변경 상태 아님)
- name: Check installed helm plugins
  command: helm plugin list
  register: helm_plugins
  changed_when: false
  become: yes

# 3. [정석 구현] 위 목록에 'diff'가 없을 때만 설치합니다. (꼼수 없는 조건부 실행)
- name: Install helm-diff plugin
  command: helm plugin install https://github.com/databus23/helm-diff
  when: "'diff' not in helm_plugins.stdout"
  become: yes

# 4. 의존성 패키지 설치
- name: Install python3-pip
  apt:
    name: python3-pip
    state: present
  become: yes

- name: Install kubernetes python library
  pip:
    name: kubernetes
  become: yes

# 5. Helm 레포지토리 및 네임스페이스 설정
- name: Add Prometheus Community Helm Repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
  become: yes

- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  become: yes

# 6. 설정 파일 렌더링
- name: Render Prometheus Stack values file
  template:
    src: monitor-values.yml.j2
    dest: /tmp/monitor-values.yml
  vars:
    target_node: "{{ target_node_name | default('') }}"
    cluster_ip: "{{ ansible_host }}"
  become: yes

- name: Update Helm Repo
  shell: /usr/local/bin/helm repo update
  become: yes

# [추가된 부분] 6.5 기존에 꼬여서 Pending된 저장소(PVC) 강제 삭제
# GitHub Actions가 AWS 서버에 접속해서 배수구를 먼저 뚫어주는 단계입니다.
- name: Cleanup old monitoring PVCs
  command: /usr/local/bin/kubectl delete pvc -n {{ monitoring_namespace }} --all
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes
  ignore_errors: yes # 만약 지울 게 없어도 에러 내지 말고 다음으로 넘어가라는 뜻입니다.

# 7. Helm 배포 (atomic 옵션 유지)
- name: Deploy kube-prometheus-stack
  kubernetes.core.helm:
    name: monitoring
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: "{{ monitoring_namespace }}"
    values_files:
      - /tmp/monitor-values.yml
    force: yes             # <--- 추가: 기존에 꼬인 리소스(Pending 상태 등)를 강제로 교체합니다.
    cleanup_on_fail: yes    # <--- 추가: 배포 실패 시 찌꺼기를 남기지 않고 정리합니다.
    skip_crds: false 
    wait: yes
    atomic: true
    timeout: 15m0s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  become: yes

# 8. Pod 상태 확인
- name: Wait for Prometheus Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=prometheus
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: pod_list
  until: pod_list.resources | length > 0 and (pod_list.resources[0].status.phase == 'Running')
  retries: 40
  delay: 15
  become: yes

- name: Wait for Grafana Pod to be Running
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ monitoring_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=grafana
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: grafana_pod
  until: grafana_pod.resources | length > 0 and (grafana_pod.resources[0].status.phase == 'Running')
  retries: 40
  delay: 15
  become: yes
