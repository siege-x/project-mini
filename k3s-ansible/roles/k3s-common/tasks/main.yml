---
# 1. 패키지 매니저(apt) 캐시 업데이트 (재시도 로직 추가됨)
- name: Update apt cache
  apt:
    update_cache: yes
    force_apt_get: yes
    cache_valid_time: 3600
  register: apt_status       # 결과 저장
  until: apt_status is success # 성공할 때까지
  retries: 10                # 10번 재시도
  delay: 10                  # 10초 간격으로

# 2. 필수 기본 패키지 설치
# K3s는 단일 바이너리지만 curl(설치용)과 필수 런타임 라이브러리는 필요합니다.
- name: Install required packages
  apt:
    name:
      - curl
      - ca-certificates
      - gnupg
      - software-properties-common
      # K3s의 원활한 운영을 위해 추천되는 추가 패키지
      - socat
      - conntrack
    state: present

# 3. 스왑(Swap) 비활성화
# K3s는 스왑이 켜져 있어도 실행은 되지만, 성능과 안정성을 위해 끄는 것이 표준입니다.
- name: Disable swap
  shell: |
    swapoff -a
    sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
  when: disable_swap | default(true)
  changed_when: false

# 4. 커널 모듈 로드
# K3s 내장 Flannel 및 컨테이너 통신을 위해 overlay와 br_netfilter는 여전히 필요합니다.
- name: Load kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

# 5. 부팅 시 커널 모듈 자동 로드 설정
- name: Set kernel modules to load on boot
  copy:
    content: |
      overlay
      br_netfilter
    dest: /etc/modules-load.d/k3s.conf # 파일명을 k3s로 변경하여 구분합니다.

# 6. 네트워크 sysctl 설정 (IP 포워딩 활성화)
# K3s 노드 간 통신과 포드 네트워크를 위해 필수적인 설정입니다.
- name: Set sysctl parameters
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }

# --- K3s 특이사항 ---
# K8s와 달리 K3s는 자체적으로 Containerd를 관리하므로 
# 별도로 containerd를 설치(7번), 디렉토리 생성(8번), 설정 파일 생성(9번)을 
# 할 필요가 없습니다. K3s 설치 스크립트가 이를 모두 처리합니다.
