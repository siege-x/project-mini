---
- name: Check if K3s is already installed
  stat:
    path: /usr/local/bin/k3s
  register: k3s_bin

- name: Initialize K3s cluster (Server)
  shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" \
    sh -s - server \
    --cluster-cidr={{ pod_network_cidr }} \
    --service-cidr={{ service_cidr }} \
    --apiserver-advertise-address={{ ansible_host }} \
    --write-kubeconfig-mode 644
  when: not k3s_bin.stat.exists

- name: Create .kube directory for root
  file:
    path: /root/.kube
    state: directory
    mode: '0755'

- name: Link K3s config to root's kube config
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /root/.kube/config
    remote_src: yes
    owner: root
    group: root
    mode: '0600'

- name: Create .kube directory for ubuntu user
  file:
    path: /home/ubuntu/.kube
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Copy K3s config to ubuntu's kube config
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /home/ubuntu/.kube/config
    remote_src: yes
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Get K3s Node Token
  slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_node_token_encoded

- name: Set K3s Node Token fact
  set_fact:
    k3s_node_token: "{{ k3s_node_token_encoded.content | b64decode | trim }}"

- name: Wait for Flannel to be ready
  shell: kubectl get pods -n kube-system -l k8s-app=flannel --no-headers | grep -v Running | wc -l
  register: flannel_not_ready
  until: flannel_not_ready.stdout == "0"
  retries: 20
  delay: 15

- name: Wait for all nodes to be ready
  shell: kubectl get nodes --no-headers | awk '{print $2}' | grep -v Ready | wc -l
  register: not_ready_nodes
  until: not_ready_nodes.stdout == "0"
  retries: 30
  delay: 10

- name: Label worker nodes
  shell: kubectl label node {{ hostvars[item]['ansible_hostname'] }} node-role.kubernetes.io/worker=worker --overwrite
  loop: "{{ groups['agents'] }}"
  ignore_errors: true

# [Micro 잔재 삭제됨] ResourceQuota(1GB 제한) 태스크 제거
